<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Database Connections • healthcareai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Database Connections">
<meta property="og:description" content="healthcareai">
<meta property="og:image" content="https://docs.healthcare.ai/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85609357-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-85609357-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">healthcareai</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/site_only/healthcareai.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/site_only/db_connections.html">Database Connections</a>
    </li>
    <li>
      <a href="../../articles/site_only/deploy_model.html">Deploying a Model</a>
    </li>
    <li>
      <a href="../../articles/site_only/best_levels.html">Variables with Many Categories</a>
    </li>
    <li>
      <a href="../../articles/site_only/performance.html">Performance with Big Data</a>
    </li>
    <li>
      <a href="../../articles/site_only/transitioning.html">Transition from Version 1</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Functions</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/HealthCatalyst/healthcareai-r">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://healthcare-ai.slack.com/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Database Connections</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HealthCatalyst/healthcareai-r/blob/master/vignettes/site_only/db_connections.Rmd"><code>vignettes/site_only/db_connections.Rmd</code></a></small>
      <div class="hidden name"><code>db_connections.Rmd</code></div>

    </div>

    
    
<p>Let’s be honest. You need to get data from a database, do some really awesome stuff with <code>R</code>, and then write the results back to a database. RStudio (and R) can help with that. There are lots of different databases, but this document will focus on Microsoft SQL Server. RStudio supports most databases, and I’d encourage you to look at the <a href="https://db.rstudio.com/">db help pages</a> for additional resources. Andiamo!</p>
<p>If you simply want a code snippet to copy and paste, scroll to the bottom.</p>
<div id="connecting-to-a-database" class="section level1">
<h1 class="hasAnchor">
<a href="#connecting-to-a-database" class="anchor"></a>Connecting to a Database</h1>
<p>Before you can do anything, you must make a connection to your database. The <code>build_connection_string</code> function takes care of the syntax for you and returns a connection string that’s ready to be passed into <code>dbConnect</code>. After you have a valid connection, you should be able to browse the database using RStudio’s Connections pane. If you don’t have a connections pane, upgrade your RStudio. It’s worth it.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">healthcareai</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">DBI</span>)

<span class="no">my_con</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/build_connection_string.html">build_connection_string</a></span>(<span class="kw">server</span> <span class="kw">=</span> <span class="st">"HCS-GM0004"</span>,
                                  <span class="kw">database</span> <span class="kw">=</span> <span class="st">"SAM"</span>)
<span class="no">con</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(<span class="kw pkg">odbc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbc.html">odbc</a></span>(), <span class="kw">.connection_string</span> <span class="kw">=</span> <span class="no">my_con</span>)</pre></body></html></div>
<p>Your database connection is now stored in the object, <code>con</code>. You can use it in database functions that require a connection. <code>dbConnect</code> will create a persistent connection, meaning that it’s available until you disconnect. If you have a recent version of RStudio, you’ll see the connections pane has updated as well.</p>
<p><img src="figures/conn_pane.png" width="500px"></p>
<p>Each database, schema, and table is available as a drop down menu for exploration. Clicking the button in the far right column next to a table will bring up a preview of the top 1000 rows of the table.</p>
</div>
<div id="reading-data" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-data" class="anchor"></a>Reading data</h1>
<div id="using-sql-code" class="section level3">
<h3 class="hasAnchor">
<a href="#using-sql-code" class="anchor"></a>Using SQL Code</h3>
<p>From here, you can read data from the database in a couple different ways. You can use <code>db_read</code> to execute SQL code, or you can use <code>dbplyr</code> functionality to execute <code>dplyr</code> code directly against the database.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">query</span> <span class="kw">&lt;-</span> <span class="st">"SELECT
          ,COUNT(*),
          ,year(AdmitDT) as AdmitYear
          FROM [SAM].[Encounter].[PatientEncounterBASE]
          WHERE AdmitYear &gt;= 2013
          GROUP BY AdmitYear
          ORDER BY AdmitYear"</span>

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/db_read.html">db_read</a></span>(<span class="no">con</span>, <span class="no">query</span>)</pre></body></html></div>
<p>This query counts admits by year. If you don’t want to pull the results into memory, as might the be the case with large tables, set the <code>pull_into_memory</code> flag to FALSE. This will create a pointer to the database that can be executed “lazily.” In other words R will wait until the last moment to execute the statement.</p>
</div>
<div id="using-dplyr-code" class="section level3">
<h3 class="hasAnchor">
<a href="#using-dplyr-code" class="anchor"></a>Using dplyr Code</h3>
<p>The other option is to use dplyr code. Set up a reference to the table, then use it to pull data. Here, <code>tbl</code> is creating a reference and storing it in the <code>encounter</code> object. R will treat that object like a data frame and can filter, aggregate, join, etc using R or dplyr code. The last line, <code>collect()</code>, is what actually pulls the data into memory. Be sure to first <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages('tidyverse')</a></code></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)

<span class="no">encounter</span> <span class="kw">&lt;-</span> <span class="fu">tbl</span>(<span class="no">con</span>, <span class="fu">in_schema</span>(<span class="st">"Encounter"</span>, <span class="st">"PatientEncounterBASE"</span>))

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="no">encounter</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">AdmitYear</span> <span class="kw">=</span> <span class="fu">year</span>(<span class="no">AdmitDT</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">AdmitYear</span> <span class="kw">&gt;=</span> <span class="fl">2013</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">AdmitYear</span>) <span class="kw">%&gt;%</span>
  <span class="fu">tally</span>() <span class="kw">%&gt;%</span>
  <span class="fu">collect</span>()</pre></body></html></div>
<p>See <a href="https://stackoverflow.com/questions/26611717/can-dplyr-join-on-multiple-columns-or-composite-key">here</a> for help with joins using dplyr.</p>
</div>
</div>
<div id="writing-data" class="section level1">
<h1 class="hasAnchor">
<a href="#writing-data" class="anchor"></a>Writing Data</h1>
<p>Note: the odbc/DBI route doesn’t work as of 4/18</p>
<p><del>As of 4/1/2018, there are two ways to write to a database:</del></p>
<ol style="list-style-type: decimal">
<li><p><del>The latest version of <code>odbc</code>, and <code>DBI</code>, installed from Github. The CRAN version does not support database schemas.</del></p></li>
<li><p><code>RODBC</code></p></li>
</ol>
<p>In either case, the data you are trying to write must match the destination table’s column names and data types. To create the table, you use a <code>CREATE TABLE</code> statement in a tool like SSMS (or SAMD, if in the Health Catalyst environment).</p>
<p>This code assumes there is a table called <code>SAM.Sepsis.Predictions</code> with columns:</p>
<ul>
<li>patient_id (int)</li>
<li>predicted_probability (float).</li>
</ul>
<div id="writing-with-dbi" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-with-dbi" class="anchor"></a><del>Writing with DBI</del>
</h3>
<p><strong>Note: as of April 18th, DBI is not working for writing to a database</strong></p>
</div>
<div id="writing-with-rodbc" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-with-rodbc" class="anchor"></a>Writing with RODBC</h3>
<p>While it’s the route that works (as of April 18th), RODBC won’t be the preferred way to interact with a database long-term because it doesn’t work with RStudio’s connections pane. However, the package is available on CRAN and does support schemas.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RODBC</span>)
<span class="co"># Make a connection</span>
<span class="no">my_con</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/build_connection_string.html">build_connection_string</a></span>(<span class="kw">server</span> <span class="kw">=</span> <span class="st">"HCS-GM0004"</span>,
                                  <span class="kw">database</span> <span class="kw">=</span> <span class="st">"SAM"</span>)
<span class="no">con</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/odbcConnect.html">odbcDriverConnect</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">my_con</span>)

<span class="co"># Write data (normally this would come from predict)</span>
<span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">patient_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>),
                          <span class="kw">predicted_readmission</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.7</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../../reference/add_SAM_utility_cols.html">add_SAM_utility_cols</a></span>() <span class="co"># if in Health Catalyst environment</span>

<span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/sqlSave.html">sqlSave</a></span>(<span class="no">con</span>,
        <span class="no">predictions</span>,
        <span class="st">"Sepsis.Predictions"</span>,
        <span class="kw">append</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
        <span class="kw">rownames</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/odbcClose.html">odbcClose</a></span>(<span class="no">con</span>)</pre></body></html></div>
</div>
</div>
<div id="full-and-simplest-example-code" class="section level1">
<h1 class="hasAnchor">
<a href="#full-and-simplest-example-code" class="anchor"></a>Full and simplest example code</h1>
<p>If you’re confused, this is all explained above.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">healthcareai</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">DBI</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RODBC</span>)

<span class="co"># Connection string</span>
<span class="no">my_con</span> <span class="kw">&lt;-</span> <span class="kw pkg">healthcareai</span><span class="kw ns">::</span><span class="fu"><a href="../../reference/build_connection_string.html">build_connection_string</a></span>(<span class="kw">server</span> <span class="kw">=</span> <span class="st">"HCS-GM0004"</span>,
                                                <span class="kw">database</span> <span class="kw">=</span> <span class="st">"SAM"</span>)
<span class="no">con_in</span> <span class="kw">&lt;-</span> <span class="kw pkg">DBI</span><span class="kw ns">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(<span class="kw pkg">odbc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbc.html">odbc</a></span>(), <span class="kw">.connection_string</span> <span class="kw">=</span> <span class="no">my_con</span>)

<span class="co"># Reading</span>
<span class="no">query</span> <span class="kw">&lt;-</span> <span class="st">"SELECT
          ,COUNT(*),
          ,year(AdmitDT) as AdmitYear
          FROM [SAM].[Encounter].[PatientEncounterBASE]
          WHERE AdmitYear &gt;= 2013
          GROUP BY AdmitYear
          ORDER BY AdmitYear"</span>

<span class="no">d</span> <span class="kw">&lt;-</span> <span class="kw pkg">healthcareai</span><span class="kw ns">::</span><span class="fu"><a href="../../reference/db_read.html">db_read</a></span>(<span class="no">con_in</span>, <span class="no">query</span>)

<span class="co"># Writing</span>
<span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">patient_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>),
                          <span class="kw">predicted_readmission</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.7</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>))

<span class="no">con_out</span> <span class="kw">&lt;-</span> <span class="kw pkg">RODBC</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/odbcConnect.html">odbcDriverConnect</a></span>(<span class="kw">connection</span> <span class="kw">=</span> <span class="no">my_con</span>)

<span class="kw pkg">RODBC</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/sqlSave.html">sqlSave</a></span>(<span class="no">con_out</span>,
               <span class="no">predictions</span>,
               <span class="st">"Sepsis.Predictions"</span>,
               <span class="kw">append</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
               <span class="kw">rownames</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="kw pkg">DBI</span><span class="kw ns">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span>(<span class="no">con_in</span>)
<span class="kw pkg">RODBC</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/RODBC/man/odbcClose.html">odbcClose</a></span>(<span class="no">con_out</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Levi Thatcher, Michael Levy, Mike Mastanduno, Taylor Larsen, Taylor Miller, Rex Sumsion.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'ac39465bc37cbef616f5de1e646b6037',
    indexName: 'healthcareai',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
