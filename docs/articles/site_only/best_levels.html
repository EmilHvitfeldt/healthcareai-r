<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Variables with Many Categories • healthcareai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Using Variables with Many Categories">
<meta property="og:description" content="healthcareai">
<meta property="og:image" content="https://docs.healthcare.ai/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85609357-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-85609357-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">healthcareai</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/site_only/healthcareai.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/site_only/db_connections.html">Database Connections</a>
    </li>
    <li>
      <a href="../../articles/site_only/deploy_model.html">Deploying a Model</a>
    </li>
    <li>
      <a href="../../articles/site_only/best_levels.html">Variables with Many Categories</a>
    </li>
    <li>
      <a href="../../articles/site_only/performance.html">Performance with Big Data</a>
    </li>
    <li>
      <a href="../../articles/site_only/transitioning.html">Transition from Version 1</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Functions</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/HealthCatalyst/healthcareai-r">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://healthcare-ai.slack.com/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Variables with Many Categories</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HealthCatalyst/healthcareai-r/blob/master/vignettes/site_only/best_levels.Rmd"><code>vignettes/site_only/best_levels.Rmd</code></a></small>
      <div class="hidden name"><code>best_levels.Rmd</code></div>

    </div>

    
    
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>In healthcare we often have high-cardinality variables (categories with many distinct values) such as DRG, medication, or physician that we want to use in predictive models. However using all of the entries can be computationally prohibitive and, perhaps paradoxically, can hurt model performance. <code>healthcareai</code> can identify the subset of values that are most strongly associated with the outcome and so are likely to make good model features. This makes model training faster and predictions more accurate.</p>
<p>This vignette documents how to use the <code>add_best_levels</code> function to take high-cardinality factors and engineer features from them that will add to model performance. The problem <code>add_best_levels</code> addresses is when you have so many levels of a categorical variable that using them all would create a table that is so wide (when one column is created for each level, which is required for model training, though <code>healthcareai</code> and other R packages do this automatically) that training takes too long or signal is lost in noise. For example, a laboratory test results table might have thousands of unique lab tests. That presents two problems:</p>
<ol style="list-style-type: decimal">
<li><p>Creating a column for each lab test makes a very wide table. E.g. if there are one-million patients that each got one of five-thousand possible lab tests, fully encoding those tests would create a one-million by five-thousand = five-billion cell table, which will occupy a lot of RAM and likely take too long to train models on.</p></li>
<li><p>If only a subset of the tests are associated with the outcome of interest, the other categories can add a lot of noise to the signal, hurting predictive accuracy.</p></li>
</ol>
<p>For both of those reasons it would be better to create columns only for the tests that are strongly associated (positively or negatively) with the outcome variable. That is what <code>add_best_levels</code> does.</p>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">healthcareai</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<p>For this vignette, we introduce a new data table, <code>pima_meds</code>, which contains information on what medications each patient in the <code>pima_diabetes</code> dataset has taken and for how long. This dataset is built into <code>healthcareai</code> as of version 2.1.1, which you can install before it is on CRAN with <code><a href="https://remotes.r-lib.org/reference/install_github.html">remotes::install_github("HealthCatalyst/healthcareai-r@v2.1.1")</a></code>, or you can generate it yourself with the code in <a href="#appendix-data-generation">Appendix: Data Generation</a>.</p>
<p>Some patients have no meds and so don’t appear in the table, some have one med, and most have more than one. Because of this, the medication information doesn’t fit neatly into the model table (<code>pima_diabetes</code>) without being <code>pivot</code>ed. Under the hood, <code>get_best_levels</code> identifies which levels to use, and <code>add_best_levels</code> <code>pivot</code>s them into new columns on the model table. Here are the first rows in the <code>pima_meds</code> table.</p>
<pre><code># &gt; Warning: `cols` is now required when using unnest().
# &gt; Please use `cols = c(drug_name)`</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">pima_meds</span>
<span class="co"># &gt; # A tibble: 1,534 x 3</span>
<span class="co"># &gt;   patient_id medication years_taken</span>
<span class="co"># &gt;        &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt;</span>
<span class="co"># &gt; 1          1 metformin        0.856</span>
<span class="co"># &gt; 2          1 metoprolol       9.44 </span>
<span class="co"># &gt; 3          1 nexium           3.91 </span>
<span class="co"># &gt; 4          1 prednisone       2.69 </span>
<span class="co"># &gt; 5          2 tiotropium       3.53 </span>
<span class="co"># &gt; # … with 1,529 more rows</span></pre></body></html></div>
<p>To keep things simple, there are only six medications in <code>pima_meds</code>: insulin and metformin are positively associated with diabetes, prednisone and metoprolol are negatively associated with diabetes, and nexium and tiotropium and equally likely among diabetic and non-diabetic patients. In real work, you probably wouldn’t use these functions with fewer than ~100 unique categories.</p>
</div>
<div id="basic-use" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-use" class="anchor"></a>Basic Use</h1>
<p>Let’s add to <code>pima_diabetes</code> columns for whether or not the patient got the two drugs most strongly associated with diabetes. The code below does that, with comments describing what each argument does.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">pima_diabetes_meds</span> <span class="kw">&lt;-</span>
  <span class="fu"><a href="../../reference/add_best_levels.html">add_best_levels</a></span>(
    <span class="co"># Data frame with id, outcome, and (optionally) any number other features</span>
    <span class="kw">d</span> <span class="kw">=</span> <span class="no">pima_diabetes</span>,
    <span class="co"># Data frame with id, the high-cardinality factor, and (optionally) a column </span>
    <span class="co"># to be used in pivoting</span>
    <span class="kw">longsheet</span> <span class="kw">=</span> <span class="no">pima_meds</span>,
    <span class="co"># The name of the ID variable present in both tables, used to join them</span>
    <span class="kw">id</span> <span class="kw">=</span> <span class="no">patient_id</span>,
    <span class="co"># The name of the high-cardinality factor</span>
    <span class="kw">groups</span> <span class="kw">=</span> <span class="no">medication</span>,
    <span class="co"># The name of the outcome</span>
    <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">diabetes</span>,
    <span class="co"># The number of categories to keep. This many columns will be added to the first data frame</span>
    <span class="kw">n_levels</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="co"># &gt; No fill column was provided, so using "1" for present entities</span></pre></body></html></div>
<p><code>add_best_levels</code> correctly identifies two drugs associated with diabetes: insulin and metoprolol. It returns <code>pima_diabetes</code> unchanged, except that there are two new columns, one for each of the drugs identified, with 1 for patients who had the drug, and <code>NA</code> for patients who didn’t. Next, we’ll demonstrate how to change the way those columns are filled.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu">glimpse</span>(<span class="no">pima_diabetes_meds</span>)
<span class="co"># &gt; Rows: 768</span>
<span class="co"># &gt; Columns: 12</span>
<span class="co"># &gt; $ patient_id            &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …</span>
<span class="co"># &gt; $ pregnancies           &lt;int&gt; 6, 1, 8, 1, 0, 5, 3, 10, 2, 8, 4, 10, 10, 1, 5,…</span>
<span class="co"># &gt; $ plasma_glucose        &lt;int&gt; 148, 85, 183, 89, 137, 116, 78, 115, 197, 125, …</span>
<span class="co"># &gt; $ diastolic_bp          &lt;int&gt; 72, 66, 64, 66, 40, 74, 50, NA, 70, 96, 92, 74,…</span>
<span class="co"># &gt; $ skinfold              &lt;int&gt; 35, 29, NA, 23, 35, NA, 32, NA, 45, NA, NA, NA,…</span>
<span class="co"># &gt; $ insulin               &lt;int&gt; NA, NA, NA, 94, 168, NA, 88, NA, 543, NA, NA, N…</span>
<span class="co"># &gt; $ weight_class          &lt;chr&gt; "obese", "overweight", "normal", "overweight", …</span>
<span class="co"># &gt; $ pedigree              &lt;dbl&gt; 0.627, 0.351, 0.672, 0.167, 2.288, 0.201, 0.248…</span>
<span class="co"># &gt; $ age                   &lt;int&gt; 50, 31, 32, 21, 33, 30, 26, 29, 53, 54, 30, 34,…</span>
<span class="co"># &gt; $ diabetes              &lt;chr&gt; "Y", "N", "Y", "N", "Y", "N", "Y", "N", "Y", "Y…</span>
<span class="co"># &gt; $ medication_insulin    &lt;int&gt; NA, NA, 1, NA, NA, NA, NA, NA, 1, 1, NA, 1, NA,…</span>
<span class="co"># &gt; $ medication_metoprolol &lt;int&gt; 1, NA, 1, NA, 1, NA, 1, NA, NA, NA, 1, NA, 1, N…</span></pre></body></html></div>
</div>
<div id="feature-engineering" class="section level1">
<h1 class="hasAnchor">
<a href="#feature-engineering" class="anchor"></a>Feature Engineering</h1>
<p>Note the message that <code>add_best_levels</code> returned above: because no fill column was provided, “1” is used for present entries. That message actually comes through from the <code>pivot</code> function, and it means the data are being one-hot encoded: for each drug identified as a good feature, a variable is created with a “1” indicating that the patient got the drug.</p>
<p>You can customize what goes in those columns by passing arguments (<code>fill</code>, <code>fun</code>, and <code>missing_fill</code>) through to the <code>pivot</code> function. The values passed to those arguments won’t affect what columns get created, only what goes in them. By specifying <code>fill = years_taken</code> and <code>missing_fill = 0</code>, we get columns with the years each patient has been on each of the best-feature drugs with “0” entries for patients who didn’t get that drug.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">pima_diabetes_med_duration</span> <span class="kw">&lt;-</span>
  <span class="fu"><a href="../../reference/add_best_levels.html">add_best_levels</a></span>(
    <span class="kw">d</span> <span class="kw">=</span> <span class="no">pima_diabetes</span>,
    <span class="kw">longsheet</span> <span class="kw">=</span> <span class="no">pima_meds</span>,
    <span class="kw">id</span> <span class="kw">=</span> <span class="no">patient_id</span>,
    <span class="kw">groups</span> <span class="kw">=</span> <span class="no">medication</span>,
    <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">diabetes</span>,
    <span class="kw">n_levels</span> <span class="kw">=</span> <span class="fl">2</span>,
    <span class="co">### The following arguments are passed to the `pivot` function.</span>
    <span class="co"># The name of the column in longsheet to be used to fill new columns</span>
    <span class="kw">fill</span> <span class="kw">=</span> <span class="no">years_taken</span>,
    <span class="co"># The value to use for observations that lack a best level</span>
    <span class="kw">missing_fill</span> <span class="kw">=</span> <span class="fl">0</span>)
<span class="fu">glimpse</span>(<span class="no">pima_diabetes_med_duration</span>)
<span class="co"># &gt; Rows: 768</span>
<span class="co"># &gt; Columns: 12</span>
<span class="co"># &gt; $ patient_id            &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …</span>
<span class="co"># &gt; $ pregnancies           &lt;int&gt; 6, 1, 8, 1, 0, 5, 3, 10, 2, 8, 4, 10, 10, 1, 5,…</span>
<span class="co"># &gt; $ plasma_glucose        &lt;int&gt; 148, 85, 183, 89, 137, 116, 78, 115, 197, 125, …</span>
<span class="co"># &gt; $ diastolic_bp          &lt;int&gt; 72, 66, 64, 66, 40, 74, 50, NA, 70, 96, 92, 74,…</span>
<span class="co"># &gt; $ skinfold              &lt;int&gt; 35, 29, NA, 23, 35, NA, 32, NA, 45, NA, NA, NA,…</span>
<span class="co"># &gt; $ insulin               &lt;int&gt; NA, NA, NA, 94, 168, NA, 88, NA, 543, NA, NA, N…</span>
<span class="co"># &gt; $ weight_class          &lt;chr&gt; "obese", "overweight", "normal", "overweight", …</span>
<span class="co"># &gt; $ pedigree              &lt;dbl&gt; 0.627, 0.351, 0.672, 0.167, 2.288, 0.201, 0.248…</span>
<span class="co"># &gt; $ age                   &lt;int&gt; 50, 31, 32, 21, 33, 30, 26, 29, 53, 54, 30, 34,…</span>
<span class="co"># &gt; $ diabetes              &lt;chr&gt; "Y", "N", "Y", "N", "Y", "N", "Y", "N", "Y", "Y…</span>
<span class="co"># &gt; $ medication_insulin    &lt;dbl&gt; 0.0000000, 0.0000000, 1.7606305, 0.0000000, 0.0…</span>
<span class="co"># &gt; $ medication_metoprolol &lt;dbl&gt; 9.4427073, 0.0000000, 8.6279867, 0.0000000, 5.0…</span></pre></body></html></div>
<p>The <code>fun</code> argument is only relevant if there are multiple observations of the same level for the same ID; for example, if a patient could have the same drug listed twice for different periods they were on the drug, we could use <code>fun = sum</code> to get the total length of time they were on the drug.</p>
</div>
<div id="working-with-a-single-table" class="section level1">
<h1 class="hasAnchor">
<a href="#working-with-a-single-table" class="anchor"></a>Working with a single table</h1>
<p>In the examples above, each observation (each row in <code>d</code>/<code>pima_diabetes</code>) could have zero, one, or many group memberships (rows in <code>longsheet</code>/<code>pima_meds</code>). There is a special case when each observation is in exactly one group. In this case you might have only one table because the groups fit tidily into a single column in <code>d</code>. However, there might still be so many groups that creating a column for each is infeasible for the reasons described in the <a href="#summary">Summary</a>. There are other options available for this special case, e.g. <a href="http://www.win-vector.com/blog/2012/08/a-bit-more-on-impact-coding/">impact coding</a> as implemented by the <a href="https://winvector.github.io/vtreat/"><code>vtreat</code></a> package, but <code>add_best_levels</code> works well here too. In this case, simply provide the same data frame to <code>d</code> and <code>longsheet</code> and proceed as usual, but note that you will need to remove the original column at the end.</p>
<p>For example, suppose we have 100,000 patients’ zip codes and we want to predict their lengths of stay (LOS). In reality we’d want lots of other features, but we’ll keep things simple here. Creating a column for every zip code (we’ll use Intermountain West zip codes, which we’ll pretend are every integer from 80001 to 89999) would create a massive table – model training would be very slow, and including zip codes that aren’t associated with particularly long or short LOS would impair model performance. <code>add_best_levels</code> helps by identifying zip codes associated with especially long or short LOS, and creating dummy variables for those zip codes. Here is that simulated data.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">1e5</span>
<span class="no">zip_los</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(
  <span class="kw">id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>),
  <span class="kw">zip</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">80001</span>:<span class="fl">89999</span>, <span class="no">n</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
  <span class="kw">LOS</span> <span class="kw">=</span> <span class="no">zip</span> * <span class="fl">1e-4</span> + <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fl">.1</span>)))
<span class="no">zip_los</span>
<span class="co"># &gt; # A tibble: 100,000 x 3</span>
<span class="co"># &gt;      id   zip   LOS</span>
<span class="co"># &gt;   &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span>
<span class="co"># &gt; 1     1 81774  8.26</span>
<span class="co"># &gt; 2     2 81839  8.33</span>
<span class="co"># &gt; 3     3 84249  8.48</span>
<span class="co"># &gt; 4     4 89807  9.06</span>
<span class="co"># &gt; 5     5 81683  8.20</span>
<span class="co"># &gt; # … with 99,995 more rows</span></pre></body></html></div>
<p>Now we create we’ll create dummy variables for the ten zip codes likely to make the best predictors of LOS. Note that LOS was simulated as a linear function of the numeric value of the patient’s zip code (plus some random noise), so we should expect zip codes close to 80001 to be associated with especially short LOS and close to 89999 with especially long LOS. Therefore the columns added as best levels should be zip codes near the endpoints.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="../../reference/add_best_levels.html">add_best_levels</a></span>(
  <span class="kw">d</span> <span class="kw">=</span> <span class="no">zip_los</span>,
  <span class="kw">longsheet</span> <span class="kw">=</span> <span class="no">zip_los</span>,
  <span class="kw">id</span> <span class="kw">=</span> <span class="no">id</span>,
  <span class="kw">groups</span> <span class="kw">=</span> <span class="no">zip</span>,
  <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">LOS</span>,
  <span class="kw">n_levels</span> <span class="kw">=</span> <span class="fl">10</span>,
  <span class="kw">missing_fill</span> <span class="kw">=</span> <span class="fl">0L</span>
) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(-<span class="no">zip</span>)
<span class="co"># &gt; # A tibble: 100,000 x 12</span>
<span class="co"># &gt;      id   LOS zip_80008 zip_80124 zip_80337 zip_81214 zip_82412 zip_88634</span>
<span class="co"># &gt;   &lt;int&gt; &lt;dbl&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;</span>
<span class="co"># &gt; 1     1  8.26         0         0         0         0         0         0</span>
<span class="co"># &gt; 2     2  8.33         0         0         0         0         0         0</span>
<span class="co"># &gt; 3     3  8.48         0         0         0         0         0         0</span>
<span class="co"># &gt; 4     4  9.06         0         0         0         0         0         0</span>
<span class="co"># &gt; 5     5  8.20         0         0         0         0         0         0</span>
<span class="co"># &gt; # … with 99,995 more rows, and 4 more variables: zip_89136 &lt;int&gt;,</span>
<span class="co"># &gt; #   zip_89299 &lt;int&gt;, zip_89586 &lt;int&gt;, zip_89932 &lt;int&gt;</span></pre></body></html></div>
<p>Note that we remove the <code>zip</code> column at the end because otherwise modeling functions would create a column for every zip code. You only have to do this when providing the same data frame to <code>d</code> and <code>longsheet</code>.</p>
</div>
<div id="adding-best-levels-in-deployment" class="section level1">
<h1 class="hasAnchor">
<a href="#adding-best-levels-in-deployment" class="anchor"></a>Adding best levels in deployment</h1>
<p>It’s one thing to identify and create useful features for model training, but <code>healthcareai</code> goes to great lengths to make model deployment easy and reliable so that you can count on getting good predictions in production. Once you’ve identified the best levels, added them to your training dataset, and trained models on that dataset, you can reliably get the same features in deployment. You do this by passing to the <code>levels</code> argument of <code>add_best_levels</code> either a model trained on a data frame that came back from <code>add_best_levels</code>, or the data frame that came back from <code>add_best_levels</code> itself.</p>
<p>For example, suppose we get a new patient with the following attributes. We can add her medication information to the rest of her data, creating exactly the same columns as in the training dataset. The best levels aren’t being identified here (they couldn’t be because there’s only one observation and we don’t know her outcome!). Instead we apply the information from the training dataset to achieve the same transformations here. Note that the patient got nexium and metoprolol, but columns are created for metoprolol and insulin.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">new_patient</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(<span class="kw">patient_id</span> <span class="kw">=</span> <span class="fl">999</span>, <span class="kw">pregnancies</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">plasma_glucose</span> <span class="kw">=</span> <span class="fl">94</span>,
                      <span class="kw">diastolic_bp</span> <span class="kw">=</span> <span class="fl">69</span>, <span class="kw">skinfold</span> <span class="kw">=</span> <span class="fl">24</span>, <span class="kw">insulin</span> <span class="kw">=</span> <span class="fl">NA</span>,
                      <span class="kw">weight_class</span> <span class="kw">=</span> <span class="st">"normal"</span>, <span class="kw">pedigree</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">age</span> <span class="kw">=</span> <span class="fl">22</span>)
<span class="no">new_meds</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(<span class="kw">patient_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">999</span>, <span class="fl">2</span>),
                   <span class="kw">medication</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"nexium"</span>, <span class="st">"metoprolol"</span>),
                   <span class="kw">years_taken</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>, <span class="fl">2.4</span>))
<span class="no">new_patient_med_duration</span> <span class="kw">&lt;-</span>
  <span class="fu"><a href="../../reference/add_best_levels.html">add_best_levels</a></span>(<span class="kw">d</span> <span class="kw">=</span> <span class="no">new_patient</span>,
                  <span class="kw">longsheet</span> <span class="kw">=</span> <span class="no">new_meds</span>,
                  <span class="kw">id</span> <span class="kw">=</span> <span class="no">patient_id</span>,
                  <span class="kw">groups</span> <span class="kw">=</span> <span class="no">medication</span>,
                  <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">diabetes</span>,
                  <span class="kw">n_levels</span> <span class="kw">=</span> <span class="fl">2</span>,
                  <span class="kw">levels</span> <span class="kw">=</span> <span class="no">pima_diabetes_med_duration</span>,
                  <span class="kw">fill</span> <span class="kw">=</span> <span class="no">years_taken</span>,
                  <span class="kw">missing_fill</span> <span class="kw">=</span> <span class="fl">0</span>)
<span class="fu">glimpse</span>(<span class="no">new_patient_med_duration</span>)
<span class="co"># &gt; Rows: 1</span>
<span class="co"># &gt; Columns: 11</span>
<span class="co"># &gt; $ patient_id            &lt;dbl&gt; 999</span>
<span class="co"># &gt; $ pregnancies           &lt;dbl&gt; 0</span>
<span class="co"># &gt; $ plasma_glucose        &lt;dbl&gt; 94</span>
<span class="co"># &gt; $ diastolic_bp          &lt;dbl&gt; 69</span>
<span class="co"># &gt; $ skinfold              &lt;dbl&gt; 24</span>
<span class="co"># &gt; $ insulin               &lt;lgl&gt; NA</span>
<span class="co"># &gt; $ weight_class          &lt;chr&gt; "normal"</span>
<span class="co"># &gt; $ pedigree              &lt;dbl&gt; 0.5</span>
<span class="co"># &gt; $ age                   &lt;dbl&gt; 22</span>
<span class="co"># &gt; $ medication_metoprolol &lt;dbl&gt; 2.4</span>
<span class="co"># &gt; $ medication_insulin    &lt;dbl&gt; 0</span></pre></body></html></div>
<div id="using-models-to-add-best-levels" class="section level2">
<h2 class="hasAnchor">
<a href="#using-models-to-add-best-levels" class="anchor"></a>Using Models to Add Best Levels</h2>
<p>When you train models on a data frame that has had best levels added to it, and then you go make predictions from those models, you’ll need to add best levels in the same way on the prediction dataset. Here’s how to do that.</p>
<p>As above, we’re using the determination of best levels from the training data and applying it to the data we want a prediction from, but now we pass the trained model object to the <code>levels</code> argument. That means that you don’t have to carry any additional objects into your deployment environment – just the model and whatever data you want to predict on.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">models</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/machine_learn.html">machine_learn</a></span>(<span class="no">pima_diabetes_med_duration</span>, <span class="no">patient_id</span>, <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">diabetes</span>,
                        <span class="kw">models</span> <span class="kw">=</span> <span class="st">"xgb"</span>, <span class="kw">tune</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="../../reference/add_best_levels.html">add_best_levels</a></span>(<span class="kw">d</span> <span class="kw">=</span> <span class="no">new_patient</span>,
                <span class="kw">longsheet</span> <span class="kw">=</span> <span class="no">new_meds</span>,
                <span class="kw">id</span> <span class="kw">=</span> <span class="no">patient_id</span>,
                <span class="kw">groups</span> <span class="kw">=</span> <span class="no">medication</span>,
                <span class="kw">outcome</span> <span class="kw">=</span> <span class="no">diabetes</span>,
                <span class="kw">n_levels</span> <span class="kw">=</span> <span class="fl">2</span>,
                <span class="kw">levels</span> <span class="kw">=</span> <span class="no">models</span>,
                <span class="kw">fill</span> <span class="kw">=</span> <span class="no">years_taken</span>,
                <span class="kw">missing_fill</span> <span class="kw">=</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">models</span>, <span class="no">.</span>)
<span class="co"># &gt; # A tibble: 1 x 12</span>
<span class="co"># &gt;   predicted_diabe… patient_id pregnancies plasma_glucose diastolic_bp skinfold</span>
<span class="co"># &gt; *            &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># &gt; 1         0.000498        999           0             94           69       24</span>
<span class="co"># &gt; # … with 6 more variables: insulin &lt;lgl&gt;, weight_class &lt;chr&gt;, pedigree &lt;dbl&gt;,</span>
<span class="co"># &gt; #   age &lt;dbl&gt;, medication_metoprolol &lt;dbl&gt;, medication_insulin &lt;dbl&gt;</span></pre></body></html></div>
</div>
</div>
<div id="get_best_levels" class="section level1">
<h1 class="hasAnchor">
<a href="#get_best_levels" class="anchor"></a>get_best_levels</h1>
<p><code>add_best_levels</code> is a convenience function that wraps two workhorses: <code>get_best_levels</code> and <code>pivot</code>. <code>get_best_levels</code> does the work of identifying which levels should be used as features. You can call it directly the same way you’d call <code>add_best_levels</code> (sans the arguments to <code>pivot</code>), but instead of adding columns to the data frame, you get back a character vector of the best levels. Next, we look at how <code>get_best_levels</code> determines what those levels are.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="../../reference/add_best_levels.html">get_best_levels</a></span>(<span class="no">pima_diabetes</span>, <span class="no">pima_meds</span>, <span class="no">patient_id</span>, <span class="no">medication</span>, <span class="no">diabetes</span>, <span class="fl">4</span>)
<span class="co"># &gt; [1] "metoprolol" "insulin"    "prednisone" "metformin"</span></pre></body></html></div>
<div id="mathematics" class="section level2">
<h2 class="hasAnchor">
<a href="#mathematics" class="anchor"></a>Mathematics</h2>
<p>Basically, <code>get_best_levels</code> identifies groups that are present in many observations and are strongly and consistently associated with a certain type of outcome. It returns equal numbers of groups that are positively and negatively associated with the outcome. The mechanics are different for regression and classification problems.</p>
<div id="regression" class="section level3">
<h3 class="hasAnchor">
<a href="#regression" class="anchor"></a>Regression</h3>
<p>When the outcome is numeric, groups that are consistently associated with outcomes far from the mean are likely to be useful, because outcomes near the mean are the easiest to predict. Groups with similar outcomes and groups with many observations are also preferable. So, <code>get_best_levels</code> calculates how far the group-mean outcome is from the overall-mean outcome and balances that against how cohesive the group is (how small is variance within the group) and how common the group is (what fraction of observations are in the group). Specifically the following statistic, <span class="math inline">\(\Omega\)</span>, is calculated for each group, and the <code>n_levels</code> groups with the greatest absolute value of <span class="math inline">\(\Omega\)</span> are used, subject to the constraint that an equal number of groups are used with positive and negative values of <span class="math inline">\(\bar{y_j} - \bar{y}\)</span> if possible. That constraint assures that the features will be useful for predicting both particularly large and small outcomes. Here, <span class="math inline">\(j\)</span> is the group, <span class="math inline">\(y\)</span> is the outcome, <span class="math inline">\(\sigma^2\)</span> is variance, and <span class="math inline">\(n_j\)</span> is the number of observations in <span class="math inline">\(j\)</span>.</p>
<p><span class="math display">\[\Omega_j = \frac{\bar{y_j} - \bar{y}}{\sqrt{\sigma^2_j / n_j}}\]</span></p>
</div>
<div id="classification" class="section level3">
<h3 class="hasAnchor">
<a href="#classification" class="anchor"></a>Classification</h3>
<p>For categorical outcomes, an ideal group has two characteristics: it is consistently associated with one of the outcome classes, and it is common among observations. <code>get_best_levels</code> calculates a “log-loss” type statistic for the distance from each of those ideals for each group, and returns the groups closest to the ideal, as above, subject to the constraint that half are associated with the positive class and half with the negative class if possible.</p>
<p>There is one user-customizable parameter for classification, <code>cohesion_weight</code> (<span class="math inline">\(\xi\)</span> in the equation below), which controls how much to value all the observations in a group having the same outcome, relative to the group being common. Its default value is 2. If which levels are added is important for model performance, <code>cohesion_weight</code> could be tuned, e.g. by cross validation.</p>
<p>Specifically, the best groups are identified as those with the smallest values of <span class="math inline">\(\Omega_j\)</span>, subject to the constraint that half are associated with each of the positive and negative classes, if possible. <span class="math inline">\(p_j^{y_1}\)</span> is the proportion of observations in group <span class="math inline">\(j\)</span> that are of the positive outcome class, and <span class="math inline">\(C_j\)</span> is an indicator variable for which outcome group-<span class="math inline">\(j\)</span> is associated with: it takes the value 1 if a greater fraction of observations in <span class="math inline">\(j\)</span> are associated with the positive class than in the median group, and 0 otherwise.</p>
<p><span class="math display">\[\Omega_j = (-C_j\ln{p_j^{y_1}} - (1 - C_j)(\ln{(1 - p_j^{y_1})}))^\xi \times -\ln (n_j/n)\]</span></p>
<p>The mathematically intuitive will notice that <span class="math inline">\(\Omega_j\)</span> blows up when every observation is in the group or the group is universally associated with one outcome. In these cases, the intermediate statistics are moved a small distance (0.5) from the endpoint before their logarithm is taken.</p>
</div>
</div>
</div>
<div id="appendix-data-generation" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix-data-generation" class="anchor"></a>Appendix: Data Generation</h1>
<p>We now show how we generated the <code>pima_meds</code> table that supplements the <code>pima_diabetes</code> dataset. This is “FYI” and is not necessary to understand how to use <code>add_best_levels</code> or <code>get_best_levels</code>.</p>
<p>First we create a table of medications with a numeric value declaring how common the medication is among diabetic patients, with values close to one indicating medications that are used almost exclusively in diabetics, values close to zero being counter-indicated for diabetics, and values near 0.5 being used equally among diabetic and non-diabetic patients.</p>
<p>Insulin and metformin are both strong indicators that a patient has diabetes. Prednisone is a corticosteroid that can cause blood sugar to spike and so might be used more rarely in patients with diabetes. Metoprolol is a beta-blocker that can mask symptoms of hypoglycemia and so might be avoided by diabetics. Nexium and tiotropium are both common drugs that we don’t expect to be more- or less-common in diabetic patients than in non-diabetic patients.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">meds</span> <span class="kw">&lt;-</span> <span class="fu">tribble</span>(
  ~ <span class="no">name</span>, ~ <span class="no">predicts_diabetes</span>,
  <span class="st">"insulin"</span>, <span class="fl">.99</span>,
  <span class="st">"metformin"</span>, <span class="fl">.95</span>,
  <span class="st">"prednisone"</span>, <span class="fl">.25</span>,
  <span class="st">"metoprolol"</span>, <span class="fl">.2</span>,
  <span class="st">"nexium"</span>, <span class="fl">.5</span>,
  <span class="st">"tiotropium"</span>, <span class="fl">.5</span>
)</pre></body></html></div>
<p>Now we take each patient and choose 0 - 4 (at random) medications for them, with the probability they have each medication proportional to <code>meds$predicts_diabetes</code> if the patient has diabetes, and <code>1 - meds$predicts_diabetes</code> if they don’t. We also create a <code>years_taken</code> variable, which is sampled at random from an exponential distribution. So, some patients won’t appear in this table (those who got 0 meds), some will have one row (those who got 1 med), and some will have multiple rows (those who got more than 1 med).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">pima_meds</span> <span class="kw">&lt;-</span>
  <span class="no">pima_diabetes</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">patient_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">drug_name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu">tibble</span>(
    <span class="kw">medication</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">meds</span>$<span class="no">name</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">0</span>:<span class="fl">4</span>, <span class="fl">1</span>), <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                        <span class="kw">prob</span> <span class="kw">=</span> <span class="kw">if</span> (<span class="no">diabetes</span> <span class="kw">==</span> <span class="st">"Y"</span>) <span class="no">meds</span>$<span class="no">predicts_diabetes</span> <span class="kw">else</span> <span class="fl">1</span> - <span class="no">meds</span>$<span class="no">predicts_diabetes</span>),
    <span class="kw">years_taken</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">medication</span>), <span class="kw">rate</span> <span class="kw">=</span> <span class="fl">.2</span>)))
  ) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>()</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Levi Thatcher, Michael Levy, Mike Mastanduno, Taylor Larsen, Taylor Miller, Rex Sumsion.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'ac39465bc37cbef616f5de1e646b6037',
    indexName: 'healthcareai',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
